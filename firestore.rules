rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Chat rooms can be read by anyone, but only created by signed-in users.
    // No one can update or delete them directly.
    match /chatRooms/{roomId} {
      allow read, list: if true;
      allow create: if request.auth != null;
      // Allow users to update the publicKeys map
      allow update: if request.auth != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['publicKeys']);
      allow delete: if false;

      // Messages can be created by any authenticated user.
      // They can only be read (listed) if the user is the recipient.
      // No one can update or delete them directly.
      match /messages/{messageId} {
        allow write: if request.auth != null;
        allow read: if request.auth != null && resource.data.recipientId == request.auth.uid;
        // This allows a user to query for messages where they are the recipient.
        allow list: if request.auth != null && request.query.get('where')[0][1] == 'recipientId' && request.query.get('where')[0][2] == request.auth.uid;
        allow update, delete: if false;
      }
    }
  }
}
