/**
 * @file Firestore Security Rules for Chat Application
 * @description This ruleset enforces a security model that prioritizes anonymous authentication and localized chat rooms, with unreadable message content stored in Firestore due to local end-to-end encryption.
 *
 * Data Structure:
 * - /chatRooms: Top-level collection containing chat room metadata (name, region, etc.).
 * - /chatRooms/{chatRoomId}/messages: Subcollection containing individual chat messages for each chat room.
 *
 * Key Security Decisions:
 * - Read access to chatRooms is public to allow listing of available rooms.
 * - Write access to chatRooms is open. In a real-world application, writes would need to be secured to prevent abuse.
 * - Read and write access to chat messages within a chat room requires only that the user is signed in (anonymous auth is sufficient).
 * - The content of chat messages is assumed to be unreadable in Firestore due to local encryption.
 * - User limits for chat rooms are managed with backend functions.
 *
 * Denormalization for Authorization:
 * - The current model avoids denormalization because authorization is primarily based on authentication status rather than specific user roles or memberships within chat rooms.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to chat rooms and open write access.
     * @path /chatRooms
     * @allow (get, list): Any user can read chat room metadata.
     * @allow (create): Any authenticated user can create a chat room.
     * @deny (update, delete): No one can update or delete chat rooms through direct Firestore access.
     * @principle Allows listing of available chat rooms and open access to chat room creation.
     */
    match /chatRooms {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read and write messages within a chat room.
     * @path /chatRooms/{chatRoomId}/messages
     * @allow (get, list): Any authenticated user can read messages in a chat room.
     * @allow (create): Any authenticated user can create messages in a chat room.
     * @deny (update, delete): No one can update or delete messages through direct Firestore access.
     * @principle Requires authentication for all chat message operations.
     */
    match /chatRooms/{chatRoomId}/messages/{messageId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }
  }
}